<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Parallel computing with dask</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computing and Programming for Environmental Research</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="Syllabus.html">
    <span class="fa fa-bell-o"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="Schedule.html">
    <span class="fa fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li>
  <a href="Resource.html">
    <span class="fa fa-wrench"></span>
     
    Resource
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Assignment_01.html">Assignment 01</a>
    </li>
    <li>
      <a href="Assignment_02.html">Assignment 02</a>
    </li>
    <li>
      <a href="Assignment_03.html">Assignment 03</a>
    </li>
    <li>
      <a href="Assignment_04.html">Assignment 04</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Parallel computing with
<code>dask</code></h1>

</div>


<blockquote>
<p>“Data is the new science. Big Data holds the answers.” - Pat
Gelsinger</p>
</blockquote>
<hr />
<div id="prerequisites" class="section level1">
<h1>Prerequisites</h1>
<p>In this section, we will use daily data from the <a
href="https://www.aviso.altimetry.fr/en/home.html">AVISO</a> sea-surface
height satellite altimetry dataset. Download the file
(<code>aviso_2015.zip</code>, ~ <code>390 MB</code>) <a href="">from
here</a>, unzip it, you will have a folder (<code>aviso_2015</code>)
containing <code>365</code> netcdf (nc) files. Move the folder to your
working directory.</p>
<p><strong>Important:</strong></p>
<p>In this section, we will use the <code>cper</code> environment you
created in <a
href="https://zhu-group.github.io/ese5023/Section_11.html#Creating_a_Python_environment">Section
11</a>. Make sure you have it activated, and open
<code>jupter notebook</code> under it, not the <code>base</code>
environment.</p>
<hr />
</div>
<div id="dask-for-parallel-computing" class="section level1">
<h1><code>Dask</code> for parallel computing</h1>
<p>In past lectures, we learned how to use <code>numpy</code>,
<code>pandas</code>, and <code>xarray</code> to analyze various types of
data. In this section, we address an increasingly common problem: what
happens if the data we wish to analyze is “big data”.</p>
<p>A good threshold for when data becomes difficult to deal with is when
the volume of data exceeds your computer’s RAM (Random-access memory).
Most modern laptops have between <code>2 GB</code> and
<code>16 GB</code> of RAM. High-end workstations and servers can have
<code>1 TB</code> or RAM or more. If the dataset you are trying to
analyze can’t fit in your computer’s memory, some special care is
required to carry out the analysis.</p>
<p>The next threshold of difficulty is when the data can’t fit on your
hard drive. Most modern laptops have between <code>100 GB</code> and
<code>4 TB</code> of storage space on the hard drive. If you can’t fit
your dataset on your internal hard drive, you can buy an external hard
drive. However, at that point you are better off using a high-end
server, HPC system, or cloud-based storage for your dataset. Once you
have many <code>TB</code> of data to analyze, you are definitely in the
realm of “big data”.</p>
<div id="introduction-to-dask" class="section level2">
<h2>Introduction to <code>dask</code></h2>
<p><code>Dask</code> is a tool that helps us easily extend our familiar
<code>Python</code> data analysis tools to medium and big data,
<em>i.e.</em> dataset that can’t fit in our computer’s RAM. In many
cases, <code>dask</code> also allows us to speed up our analysis by
using multiple CPU cores. <code>Dask</code> can help us work more
efficiently on our laptop, and it can also help us <strong>scale
up</strong> our analysis on HPC and cloud platforms. Most importantly,
<code>dask</code> is almost invisible to the user, meaning that you can
focus on your science, rather than the details of parallel
computing.</p>
<p><code>Dask</code> provides collections for big data and a scheduler
for parallel computing. In this section, we will learn the basics of
using <code>dask</code> through examples. For more about
<code>dask</code>, check <a href="https://docs.dask.org/en/latest/">The
Dask Documentation</a> and <a href="https://github.com/dask/dask">The
Dask Github Site</a>. For other modules enabling parallel computing,
check <a href="https://wiki.python.org/moin/ParallelProcessing">Parallel
Processing and Multiprocessing in Python</a>.</p>
</div>
<div id="dask-arrays" class="section level2">
<h2><code>Dask</code> arrays</h2>
<p>A <code>dask</code> array looks and feels a lot like a
<code>numpy</code> array. However, a <code>dask</code> array doesn’t
directly hold any data. Instead, it <strong>symbolically</strong>
represents the computations needed to generate the data. Nothing is
actually computed until the actual numerical values are needed. This
mode of operation is called <em>lazy</em>; it allows one to build up
complex, large calculations symbolically before turning them over the
scheduler for execution.</p>
<p>If we want to create a numpy array of all ones, we do it like
this:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Create a numpy array</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>shape <span class="op">=</span> (<span class="dv">1000</span>, <span class="dv">4000</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>ones_np <span class="op">=</span> np.ones(shape)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>ones_np</span></code></pre></div>
<p>This array contains exactly <code>32 MB</code> of data:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Check the size of array in MB</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>ones_np.nbytes <span class="op">/</span> <span class="fl">1e6</span></span></code></pre></div>
<p>Now let’s create the same array using <code>dask</code>’s array
interface:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Create a dask array</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>ones_da <span class="op">=</span> da.ones(shape)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>ones_da</span></code></pre></div>
<p>As you see, <code>dask</code> create the array in one <em>chunk</em>.
In fact, a crucial advantage with <code>dask</code> is that we can
specify the <code>chunks</code> argument. Here, <code>chunks</code>
describes how the array is split up over many sub-arrays. There are <a
href="https://dask.pydata.org/en/latest/array-creation.html#chunks">several
ways</a> to specify chunks. In this section, we will use a block
shape:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Specify the chunk</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>chunk_shape <span class="op">=</span> (<span class="dv">1000</span>, <span class="dv">1000</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>ones_da <span class="op">=</span> da.ones(shape, chunks<span class="op">=</span>chunk_shape)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>ones_da</span></code></pre></div>
<p>Notice that we just see a symbolic representation of the array,
including its <code>shape</code>, <code>dtype</code>, and
<code>chunksize</code>. No data has been generated yet. When we call
<code>.compute()</code> on a <code>dask</code> array, the computation is
trigger and the <code>dask</code> array becomes a <code>numpy</code>
array.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Run computation</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>ones_da.compute()</span></code></pre></div>
<p>In order to understand what happened when we called
<code>.compute()</code>, you can visualize the <code>dask</code>
<em>graph</em>, the symbolic operations that make up the array:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Visualize the computation</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>ones_da.visualize()</span></code></pre></div>
<p>As you find, the array has <code>4</code> chunks. To generate it,
<code>dask</code> calls <code>np.ones</code> four times and then
concatenates this together into one array.</p>
<p>Rather than immediately loading a <code>dask</code> array (which puts
all the data into RAM), it is more common to want to reduce the data
somehow. For example:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Reduce the array with sum()</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>sum_of_ones <span class="op">=</span> ones_da.<span class="bu">sum</span>()</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co"># Visualize the computation</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>sum_of_ones.visualize()</span></code></pre></div>
<p>Here we see <code>dask</code>’s strategy for finding the
<code>sum</code>. This simple example illustrates the beauty of
<code>dask</code>: it <strong>automatically</strong> designs an
algorithm appropriate for custom operations with big data.</p>
</div>
<div id="a-bigger-calculation" class="section level2">
<h2>A bigger calculation</h2>
<p>The previous example are too simple - the data (<code>32 MB</code>)
is nowhere nearly big enough to warrant the use of <code>dask</code>.
Let’s make it a lot bigger:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># A much bigger array</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>bigshape <span class="op">=</span> (<span class="dv">200000</span>, <span class="dv">4000</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co"># Define the array (lazy method)</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>big_ones <span class="op">=</span> da.ones(bigshape, chunks<span class="op">=</span>chunk_shape)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co"># Run computation</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>big_ones</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co"># Check the size of array in MB</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>big_ones.nbytes <span class="op">/</span> <span class="fl">1e6</span></span></code></pre></div>
<p>This dataset is <code>6.4 GB</code>! This is probably close to or
greater than the amount of available RAM than you have in your computer.
Nevertheless, <code>dask</code> has no problem working on it. When doing
a big calculation, <code>dask</code> also has some tools to help us
understand what is happening.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Import ProgressBar</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="im">from</span> dask.diagnostics <span class="im">import</span> ProgressBar</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># Define the computation (lazy method)</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>calc <span class="op">=</span> (np.cos(big_ones)<span class="op">**</span><span class="dv">2</span>).mean()</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co"># Show ProgressBar</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="cf">with</span> ProgressBar():</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    <span class="co"># Run computation</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    result <span class="op">=</span> calc.compute()</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co"># Show result</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>result</span></code></pre></div>
<p>In fact, all the usual <code>numpy</code> methods work on
<code>dask</code> arrays. You can also apply <code>numpy</code> function
directly to a <code>dask</code> array, and it will stay “lazy” until the
computation starts.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Define the computation (lazy method)</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>calc2 <span class="op">=</span> (np.exp(big_ones)<span class="op">**</span><span class="dv">10</span>).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>calc2</span></code></pre></div>
<p>Plotting also triggers computation, since we need the actual
values.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Run computation and plot</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>plt.plot(calc2)</span></code></pre></div>
</div>
<div id="making-a-local-client" class="section level2">
<h2>Making a local client</h2>
<p><code>Dask</code> has several ways of executing code in parallel.
We’ll use the <a
href="http://distributed.dask.org/en/stable/">distributed scheduler</a>
by creating a <code>dask.distributed.Client</code>.</p>
<p>For now, this will provide us with some nice diagnostics. Let’s make
a local client (<code>my_client</code>) with <code>4</code> workers
(<code>1</code> thread per worker):</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Use the distributed scheduler to form a local client (cluster)</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co"># 4 workers, 1 thread (CPU) per worker</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>my_client <span class="op">=</span> Client(n_workers<span class="op">=</span><span class="dv">4</span>, threads_per_worker<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co"># Show information of the local client</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>my_client.cluster</span></code></pre></div>
<p>Click the the Dashboard link, get yourself familiarized with it.</p>
<p>If you no longer use a client, make sure to close your client or stop
this kernel:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>my_client.close()</span></code></pre></div>
</div>
<div id="parallelizing-code-with-dask.delayed" class="section level2">
<h2>Parallelizing code with <code>dask.delayed()</code></h2>
<p>In this sub-section we parallelize some simple code with
<code>dask</code> and <a
href="https://docs.dask.org/en/latest/delayed.html"><code>dask.delayed</code></a>.
Often, this is the only function that you will need to convert functions
for use with <code>dask</code>. This is a simple way to use
<code>dask</code> to parallelize existing codebases or build complex
systems.</p>
<p>First let’s make some toy functions, <code>fun1</code> and
<code>fun2</code>, that sleep for a while to simulate work. We’ll then
time running these functions normally.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Define two functions</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">def</span> fun1(x):</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="kw">def</span> fun2(x, y):</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span></code></pre></div>
<p>We then time the execution of this normal code using the
<code>%%time</code> magic, which is a special function of the
<code>Jupyter Notebook</code>.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co"># This takes three seconds to run because we call each</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># function sequentially, one after the other</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co"># Call fun1</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>x <span class="op">=</span> fun1(<span class="dv">1</span>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co"># Call fun1</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>y <span class="op">=</span> fun1(<span class="dv">2</span>)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co"># Call fun2</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>z <span class="op">=</span> fun2(x, y)</span></code></pre></div>
<p>Those two increment calls could be called in parallel, because they
are totally <strong>independent of one-another</strong>.</p>
<p>We’ll transform the <code>fun1</code> and <code>fun2</code> functions
using the <code>dask.delayed()</code> function. When we call the
<strong>delayed version</strong> by passing the arguments, exactly as
before, the original function isn’t actually called yet - which is why
the cell execution finishes very quickly. Instead, a delayed object is
made, which keeps track of the function to call and the arguments to
pass to it.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co"># This runs immediately, all it does is build a graph</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>x <span class="op">=</span> delayed(fun1)(<span class="dv">1</span>)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>y <span class="op">=</span> delayed(fun1)(<span class="dv">2</span>)</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>z <span class="op">=</span> delayed(fun2)(x, y)</span></code></pre></div>
<p>This ran immediately, since nothing has really happened yet. To get
the result, call <code>compute</code>. Notice that this runs faster than
the original code.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co"># This actually runs our computation using a local cluster</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>z.compute()</span></code></pre></div>
<p>Here, the <code>z</code> object is a <em>lazy</em>
<code>Delayed</code> object, which holds everything we need to compute
the final result, including references to all of the functions that are
required and their inputs and relationship to one-another. We can
evaluate the result with <code>.compute()</code> as above or we can
visualize the task graph for this value with <code>.visualize()</code>.
As you can see, such a lazy execution allows building up complex, large
calculations symbolically before turning them over to the scheduler for
execution. For more, check <a
href="https://tutorial.dask.org/03_dask.delayed.html"><code>dask</code>
delayed execution</a>.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># Look at the task graph for z</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>z.visualize()</span></code></pre></div>
<p>Notice that this includes the names of the functions from before, and
the logical flow of the outputs of the <code>fun1</code> functions to
the inputs of <code>fun2</code>.</p>
</div>
<div id="parallelizing-a-for-loop-with-dask.delayed"
class="section level2">
<h2>Parallelizing a <code>for</code> loop with
<code>dask.delayed()</code></h2>
<p><code>for</code> loops are one of the most common things that we want
to parallelize. Use <code>dask.delayed</code>on <code>fun1</code> and
<code>sum</code> to parallelize the computation below:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># Make a simple list</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co"># Sequential code</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co"># Loop element one by one</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> data:</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    temp <span class="op">=</span> fun1(i)</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    results.append(temp)</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co"># Compute</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="co"># After it&#39;s computed</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;After computing :&quot;</span>, total)  </span></code></pre></div>
<p>A parallel version with <code>dask.delayed()</code> would be:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co"># Parallel code </span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> data:</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>    temp <span class="op">=</span> delayed(fun1)(i)</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    results.append(temp)</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co"># Define the method</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>total <span class="op">=</span> delayed(<span class="bu">sum</span>)(results)</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co"># Let&#39;s see what type of thing total is</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Before computing:&quot;</span>, total)</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co"># Compute</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>result <span class="op">=</span> total.compute()</span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co"># After it&#39;s computed</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;After computing :&quot;</span>, result) </span></code></pre></div>
<p>Visualize the task graph for this:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># Look at the task graph for total</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>total.visualize()</span></code></pre></div>
<p>Now enlarge <code>data</code> to a larger list, <em>e.g</em>,
<code>[1, 2, 3, 4, 5, 6, 7, 8]</code>. Check what would happen to the
running time of <code>total</code>? Can you figure out why?</p>
</div>
<div id="combing-dask-and-xarray" class="section level2">
<h2>Combing <code>dask</code> and <code>xarray</code></h2>
<p><code>Xarray</code> can automatically wrap its data in <a
href="https://tutorial.dask.org/02_array.html"><code>dask</code>
arrays</a>. This capability turns <code>xarray</code> into an extremely
powerful tool for Big Data earth science.</p>
<p>To illustrate this in action, we will use a fairly large dataset to
analyze. This file contains <code>1</code> year of daily data from the
<a href="https://www.aviso.altimetry.fr/en/home.html">AVISO</a>
sea-surface height satellite altimetry dataset.</p>
<p>Let’s load the first file as a regular <code>xarray</code>
dataset:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># Load the first file with xarray</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>ds_first <span class="op">=</span> xr.open_dataset(<span class="st">&#39;aviso_2015/dt_global_allsat_madt_h_20150101_20150914.nc&#39;</span>)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="co"># Check the data</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>ds_first</span></code></pre></div>
<p>This one file is about <code>8 MB</code>. So <code>365</code> of them
will be nearly <code>3 GB</code>. If we had downloaded all
<code>25</code> years of data, it would be <code>73 GB</code>!. This is
a good example of “medium data”.</p>
<p>With <a
href="http://xarray.pydata.org/en/stable/generated/xarray.open_mfdataset.html"><code>open_mfdataset</code></a>,
we can easily open all the netcdf files into one <em>Dataset</em>
object.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Use open_mfdataset to load all the nc files</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>ds <span class="op">=</span> xr.open_mfdataset(<span class="st">&#39;aviso_2015/*.nc&#39;</span>)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="co"># Check data object</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co"># Notice that the values are not displayed</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>ds</span></code></pre></div>
<p>Note that the values are not displayed, since that would trigger
computation.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Get sea surface height (adt)</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>ssh <span class="op">=</span> ds.adt</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co"># Check the data, this is a dask array</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>ssh</span></code></pre></div>
<p>Try the following code, see what happens:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Compute annual mean ssh</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>ssh_2015_mean <span class="op">=</span> ssh.mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span></code></pre></div>
<p>To actually compute the data:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co"># Compute annual mean ssh</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>ssh_2015_mean.load()</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co"># Plot annual mean</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>ssh_2015_mean.plot()</span></code></pre></div>
<p>Finally, close the client (local cluster):</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># Close the client (local cluster)</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>my_client.close()</span></code></pre></div>
<hr />
</div>
</div>
<div id="python-next" class="section level1">
<h1><code>Python</code> next?</h1>
<p>So far we have covered the basics of <code>Python</code> and
fundamental modules to make plots and analyze data. Looking forward, the
learning curve is still steep, be patient as it takes time. Use Google
and <a href="https://stackoverflow.com/">stackoverflow</a> without
hesitation, as you will find 9 out 10 times your questions/issues have
been reported and solved (luckily) already.</p>
<p>Have fun!</p>
<hr />
<p><em>The notes are modified from the excellent <a
href="https://rabernat.github.io/research_computing_2018/dask-for-parallel-computing-and-big-data.html">Dask
for Parallel Computing and Big Data</a>, available freely
online.</em></p>
<hr />
</div>
<div id="in-class-exercises" class="section level1">
<h1>In-class exercises</h1>
<div id="exercise-1" class="section level2">
<h2>Exercise #1</h2>
<p>Go through the notes, make sure you understand the scripts.</p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise #2</h2>
<p>Make a local client with <code>6</code> CPUs (only if your laptop
allows!), then compute and plot the variance in daily <code>ssh</code>
anomalies with <code>dask</code>.</p>
<hr />
</div>
</div>
<div id="further-reading" class="section level1">
<h1>Further reading</h1>
<ul>
<li><a href="https://github.com/dask/dask-tutorial"><code>Dask</code>
tutorial</a></li>
<li><a
href="https://saturncloud.io/blog/a-data-scientist-s-guide-to-lazy-evaluation-with-dask/">A
Data Scientist’s Guide to Lazy Evaluation with
<code>Dask</code></a></li>
<li><a href="https://book.pythontips.com/en/latest/">Intermediate
Python</a></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
