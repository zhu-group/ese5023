<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Section 07 Intermediate Python: xarray</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computing and Programming for Environmental Research</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="Syllabus.html">
    <span class="fa fa-bell-o"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="Schedule.html">
    <span class="fa fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li>
  <a href="Resource.html">
    <span class="fa fa-wrench"></span>
     
    Resource
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Assignment_01.html">Assignment 01</a>
    </li>
    <li>
      <a href="Assignment_02.html">Assignment 02</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Section 07 Intermediate
<code>Python</code>: <code>xarray</code></h1>

</div>


<blockquote>
<p>“<code>Xarray</code> (formerly xray) is an open source project and
Python package that makes working with labelled multi-dimensional arrays
simple, efficient, and fun!” - <code>Xarray</code> document.</p>
</blockquote>
<hr />
<div id="prerequisites" class="section level1">
<h1>Prerequisites</h1>
<p>In <code>Anaconda Powershell</code>, install <code>netCDF4</code>,
<code>xarray</code>, and <code>nc-time-axis</code>, <strong>one after
another</strong>:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>pip install netCDF4</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>pip install xarray</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>pip install nc<span class="op">-</span>time<span class="op">-</span>axis</span></code></pre></div>
<p>To test whether your environment is set up properly, try the
following imports:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> netCDF4</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre></div>
<hr />
</div>
<div id="introduction-to-xarray" class="section level1">
<h1>Introduction to <code>xarray</code></h1>
<p>In <a href="https://zhu-group.github.io/ese5023/Section_06.html">last
section</a>, we saw how <code>pandas</code> handled <em>tabular</em>
datasets, by using “indexes” for each row and labels for each column.
These features, together with <code>pandas</code>’ many useful routines
for all kinds of data wrangling and analysis, have made
<code>pandas</code> one of the most popular python packages in the
world.</p>
<p>However, not all Earth science datasets easily fit into the “tabular”
model (i.e. rows and columns) imposed by <code>pandas</code>. In
particular, we often deal with <em>multidimensional</em> data. By
multidimensional data (also often called N-dimensional), it means data
with many independent dimensions or axes. For example, we might
represent Earth’s surface temperature <em>T</em> as a three dimensional
variable:</p>
<p><span class="math display">\[T(Lon, Lat, Time)  \]</span></p>
<p>The point of <code>xarray</code> is to provide <strong>pandas-level
convenience</strong> for working with this type of data. Specifically,
<code>xarray</code> is for working with labeled, multi dimensional
arrays.</p>
<ul>
<li><p>Built on top of <code>numpy</code> and
<code>pandas</code></p></li>
<li><p>Brings the power of <code>pandas</code> to multidimensional
arrays</p></li>
<li><p>Supports data of any dimensionality</p></li>
</ul>
<p><img src="figs/xarray2.png" alt="drawing" width="800"/></p>
<p><a
href="https://gdfa.ugr.es/python/climate_data/data_science_climate_data.html">Figure
source</a></p>
<hr />
</div>
<div id="xarray-basics" class="section level1">
<h1><code>Xarray</code> basics</h1>
<p>Like we did for <code>pandas</code> in <a
href="https://zhu-group.github.io/ese5023/Section_06.html">Section
06</a>, here we will go over the <strong>basic capabilities</strong> of
<code>xarray</code>. Please dig into the <a
href="https://xarray.pydata.org/en/stable/index.html"><code>xarray</code>
documentation</a> for more advanced usage.</p>
<div id="xarray-data-structures" class="section level2">
<h2><code>xarray</code> data structures</h2>
<p><code>Xarray</code> has two fundamental data structures:</p>
<ul>
<li><p>a <em>DataArray</em>, which holds a <strong>single</strong>
multi-dimensional variable and its coordinates</p></li>
<li><p>a <em>Dataset</em>, which holds <strong>multiple</strong>
variables that potentially share the same coordinates</p></li>
</ul>
<p>Check <a
href="http://xarray.pydata.org/en/latest/user-guide/data-structures.html">Data
Structures</a> for more.</p>
</div>
<div id="dataarray" class="section level2">
<h2><code>DataArray</code></h2>
<p>A <em>DataArray</em> has four essential attributes:</p>
<ul>
<li><p><code>values</code>: a <code>numpy.ndarray</code> holding the
array’s values</p></li>
<li><p><code>dims</code>: dimension names for each axis (e.g., (‘x’,
‘y’, ‘z’), (‘lon’, ‘lat’, ‘time’))</p></li>
<li><p><code>coords</code>: a dict-like container of arrays
(coordinates) that label each point (e.g., 1-dimensional arrays of
numbers, datetime objects or strings)</p></li>
<li><p><code>attrs</code>: an <code>OrderedDict</code> to hold arbitrary
metadata (attributes)</p></li>
</ul>
<p>Let’s start by constructing some DataArrays manually:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre></div>
<p>A simple <code>DataArray</code> without dimensions or coordinates
isn’t much use:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Create a xr dataarray</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>da <span class="op">=</span> xr.DataArray([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>da</span></code></pre></div>
<p>You can add a dimension name to the <code>DataArray</code>:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Add a dimension name</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>da <span class="op">=</span> xr.DataArray([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>], dims<span class="op">=</span>[<span class="st">&#39;x&#39;</span>])</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>da</span></code></pre></div>
<p>But things get most interesting when you add a coordinate:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Add a coordinate</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>da <span class="op">=</span> xr.DataArray([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                  dims<span class="op">=</span>[<span class="st">&#39;x&#39;</span>],</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                  coords<span class="op">=</span>{<span class="st">&#39;x&#39;</span>: [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>]})</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>da</span></code></pre></div>
<p>You can use <code>xarray</code> built-in plotting:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Simple plot with xr built-in plot function</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>da.plot(marker<span class="op">=</span><span class="st">&#39;o&#39;</span>)</span></code></pre></div>
</div>
<div id="datasets" class="section level2">
<h2><code>Datasets</code></h2>
<p>A <code>Dataset</code> holds many <code>DataArrays</code> which
potentially can share coordinates. In analogy to
<code>pandas</code>:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>pandas.Series : pandas.Dataframe :: xarray.DataArray : xarray.Dataset</span></code></pre></div>
<p>Constructing Datasets manually is a bit more involved in terms of
syntax. The <code>Dataset</code> takes three arguments:</p>
<ul>
<li><p><code>data_vars</code> should be a dictionary with each key as
the name of the variable and each value as one of:</p>
<ul>
<li>A <code>DataArray</code> or Variable</li>
<li>A tuple of the form <code>(dims, data[, attrs])</code>, which is
converted into arguments for Variable</li>
<li>A <code>pandas</code> object, which is converted into a
<code>DataArray</code></li>
<li>A 1D array or list, which is interpreted as values for a one
dimensional coordinate variable along the same dimension as it’s
name</li>
</ul></li>
<li><p><code>coords</code> should be a dictionary of the same form as
<code>data_vars</code></p></li>
<li><p><code>attrs</code> should be a dictionary</p></li>
</ul>
<p>For the rest of Section, we will use <a
href="http://172.18.31.60/index.php/s/2wZyWS6NK7x2kbr">an output
file</a> (<code>CESM2_200001-201412.nc</code>) from the <a
href="https://www.cesm.ucar.edu/models/cesm2/">Community Earth System
Model (CESM)</a> to show basics of <code>xarray</code> and how to handle
<code>Dataset</code> files. The file contains global monthly near
surface temperature from <code>2000</code> to <code>2014</code>. Please
download the file, and move it to your working directory.</p>
</div>
<div id="loading-data-from-a-netcdf-file" class="section level2">
<h2>Loading data from a netCDF file</h2>
<p>In fact, <code>Xarray</code>’s interface is heavily inspired by the
<code>netCDF</code> data model. And <code>xarray</code>’s
<code>Dataset</code> is designed as an in-memory representation of a
netCDF dataset.</p>
<p>First, let’s open the CESM netCDF file
(<code>CESM2_200001-201412.nc</code>) using the
<code>xarray.open_dataset()</code> function:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Open a netCDF4 file</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(<span class="st">&quot;CESM2_200001-201412.nc&quot;</span>, engine<span class="op">=</span><span class="st">&quot;netcdf4&quot;</span>)</span></code></pre></div>
<p>By default, <code>xarray.open_dataset()</code> function uses lazy
loading, i.e. it just loads in the <em>coordinate</em> and
<em>attribute</em> metadata and not the data that correspond to data
variables themselves. The data variables are loaded only on actual
values access (e.g. when performing some calculation, slicing, …) or
with <code>.load()</code> method. The <code>xarray.open_dataset()</code>
is also able to load files in other formats (e.g., <code>grib</code>,
<code>tiff</code>, or <code>zarr</code>), check <a
href="https://xarray.pydata.org/en/stable/user-guide/io.html">Reading
and writing files</a> for more.</p>
<p>Now take a look at the loaded dataset:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Show dataset</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>ds</span></code></pre></div>
<p>To check the corresponding netCDF representation, we can use the
<code>.info()</code> method:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Show dataset info</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>ds.info()</span></code></pre></div>
</div>
<div id="checking-datasets-properties" class="section level2">
<h2>Checking <code>Datasets</code> properties</h2>
<p>The <code>Datasets</code> (<code>ds</code>) have the following key
properties:</p>
<ul>
<li><p><code>data_vars</code>: an dictionary of <code>DataArrays</code>
corresponding to data variables</p></li>
<li><p><code>dims</code>: a dictionary mapping from dimension names to
the fixed length of each dimension (e.g. {‘time’: <code>180</code>,
‘lat’: <code>192</code>, ‘lon’: <code>288</code>, ‘nbnd’:
<code>2</code>} )</p></li>
<li><p><code>coords</code>: a dictionary-like container of arrays
(coordinates) that label each point (tick label) along our
dimensions</p></li>
<li><p><code>attrs</code>: a dictionary holding arbitrary metadata
pertaining to the dataset</p></li>
</ul>
<p>Check those one by one:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Check data variables</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ds.data_vars</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># Check data dimension names</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>ds.data_dims</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co"># Check data coordinates</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>ds.data_coords</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="co"># Check data attributes (metadata)</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>ds.data_attrs</span></code></pre></div>
</div>
<div id="checking-dataarray-properties" class="section level2">
<h2>Checking <code>DataArray</code> properties</h2>
<p>As we just covered, the <code>DataArray</code> is
<code>xarray</code>’s implementation of a labeled, multi-dimensional
array. It has several key properties:</p>
<ul>
<li><code>data</code>: an array (<code>numpy.ndarray</code>,
<code>dask.array</code>, or <code>sparse</code> or
<code>cupy.array</code> holding the array’s values).</li>
<li><code>dims</code>: dimension names for each axis e.g. (lat, lon,
time)</li>
<li><code>coords</code>: a dictionary-like container of arrays
(coordinates) that label each point (tick label) along our
dimensions</li>
<li><code>attrs</code>: a dictionary that holds arbitrary
attributes/metadata (such as units).</li>
<li><code>name</code>: an arbitrary name of the array</li>
</ul>
<p>For example, you can use <code>ds['tas']</code> to extract the
<code>tas</code> (near surface temperature) variable
(<code>DataArray</code>), and later check its properties one by one:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Extract the tas variable (DataArray)</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>ds[<span class="st">&#39;tas&#39;</span>]</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># The actual array data</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>ds[<span class="st">&#39;tas&#39;</span>].data</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co"># Datarray coordinates</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>ds[<span class="st">&#39;tas&#39;</span>].coords</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co"># Dataarray attributes</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>ds[<span class="st">&#39;tas&#39;</span>].attrs</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="co"># Dataarray name</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>ds[<span class="st">&#39;tas&#39;</span>].name</span></code></pre></div>
</div>
<div id="indexing-and-selecting-data" class="section level2">
<h2>Indexing and selecting data</h2>
<p><code>Xarray</code> supports two kinds of indexing:</p>
<ul>
<li><p>Positional indexing via <code>.isel()</code>: provides primarily
integer position based index (from <code>0</code> to
<code>length-1</code> of the axis/dimension)</p></li>
<li><p>Label indexing via <code>.sel()</code>: provides primarily label
based index.</p></li>
</ul>
<p>The good part of <code>xarray</code> is that, its indexing methods
preserves the coordinate labels and associated metadata.</p>
<p>Check <a
href="https://xarray.pydata.org/en/stable/user-guide/indexing.html">Indexing
and selecting data</a> for more.</p>
<div id="selection-by-position" class="section level3">
<h3>Selection by position</h3>
<p>The <code>.isel()</code> method is the primary access method for
<strong>purely integer based indexing</strong>. The following are valid
inputs:</p>
<ul>
<li><p>An integer, e.g. <code>lat=10</code></p></li>
<li><p>A list or array of integers, e.g,
<code>lon=[10, 20, 39]</code></p></li>
<li><p>A slice object (range) with integers,
e.g. <code>time=slice(2, 20)</code></p></li>
</ul>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># The original object, i.e. no selection</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>ds.tas.isel()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co"># Data at lat=100</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>ds.tas.isel(lat<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="co"># Data at lat=100 and the last two time steps </span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>ds.tas.isel(lat<span class="op">=</span><span class="dv">100</span>, time<span class="op">=</span>[<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co"># Data lat=100 and time ranging from index 10 and 20 </span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>ds.tas.isel(lon<span class="op">=</span><span class="dv">100</span>, time<span class="op">=</span><span class="bu">slice</span>(<span class="dv">10</span>, <span class="dv">20</span>))</span></code></pre></div>
</div>
<div id="selection-by-label" class="section level3">
<h3>Selection by label</h3>
<p>The <code>.sel()</code> method is the primary access method for
<strong>purely coordinate label based indexing</strong>. The following
are valid inputs:</p>
<ul>
<li><p>A single coordinate label, e.g. <code>time='2013-01-15'</code> or
<code>time='2013'</code></p></li>
<li><p>A list or array of coordinate labels,
e.g. <code>lon=['100','356.25']</code></p></li>
<li><p>A slice object with coordinate labels,
e.g. <code>time=slice("2021-01-01", "2021-03-01")</code></p></li>
</ul>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Select data in 2013</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>ds.tas.sel(time<span class="op">=</span><span class="st">&#39;2013&#39;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># Select data on 2013-01-15</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>ds.tas.sel(time<span class="op">=</span><span class="st">&#39;2013-01-15&#39;</span>)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co"># Select data from a list</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>ds.tas.sel(lon<span class="op">=</span>[<span class="st">&#39;100&#39;</span>,<span class="st">&#39;356.25&#39;</span>])</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co"># Select data within a range</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co"># Both the start and the stop are included</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>ds.tas.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&quot;2013-01-01&quot;</span>, <span class="st">&quot;2014-12-31&quot;</span>))</span></code></pre></div>
</div>
<div id="nearest-neighbor-lookups" class="section level3">
<h3>Nearest-neighbor lookups</h3>
<p>Now try:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>ds.tas.sel(lat<span class="op">=</span><span class="fl">39.5</span>, lon<span class="op">=</span><span class="fl">105.7</span>)</span></code></pre></div>
<p>Can you figure out why this did not work?</p>
<p>Be careful when working with floating coordinate labels. When we have
integer, string, datetime-like values for coordinate labels,
<code>sel()</code> works flawlessly. When we try to work with floating
coordinate labels, things get a little tricky. As shown above, when our
coordinate labels are not integers or strings or datetime-like but
floating point numbers, <code>.sel()</code> may throw a KeyError:
<code>ds.tas.sel(lat=39.5, lon=105.7)</code> fails because we are trying
to use a conditional for an <strong>approximate</strong> value, i.e
floating numbers are represented approximately inside the computer, and
<code>xarray</code> is unable to locate this exact value. To address
this issue, <code>xarray</code> supports method and tolerance keyword
argument. The method parameter allows for enabling nearest neighbor
(inexact) lookups by use of the methods <code>pad</code>,
<code>backfill</code>, or <code>nearest</code>:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># Using the nearest method to find a nearby value</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ds.tas.sel(lat<span class="op">=</span><span class="fl">39.5</span>, lon<span class="op">=</span><span class="fl">105.7</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>)</span></code></pre></div>
<p>So the closest location in the data was at
<code>lat=39.11, lon=106.2</code>.</p>
<p>See the <a
href="https://xarray.pydata.org/en/stable/generated/xarray.DataArray.sel.html"><code>xarray</code>
documentation</a> for more on usage of method and tolerance parameters
in <code>.sel()</code>.</p>
<p>Another way to use the nearest neighbor lookup is via a objects. For
example:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># Using the slice method to find a nearby value</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>ds.tas.sel(lat<span class="op">=</span><span class="bu">slice</span>(<span class="dv">39</span>, <span class="fl">39.5</span>), lon<span class="op">=</span><span class="bu">slice</span>(<span class="fl">106.1</span>, <span class="fl">106.3</span>))</span></code></pre></div>
<p>Operators can be chained, so multiple operations can be used
sequentially. For example, to select an area of interest and the first
time index, and plot the data:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>ds.tas.isel(time<span class="op">=</span><span class="dv">0</span>).sel(lon<span class="op">=</span><span class="bu">slice</span>(<span class="dv">20</span>, <span class="dv">160</span>), lat<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">80</span>, <span class="dv">25</span>)).plot()</span></code></pre></div>
</div>
</div>
<div id="basic-plotting-with-.plot" class="section level2">
<h2>Basic plotting with <code>.plot()</code></h2>
<p><code>Xarray</code> provides a <code>.plot()</code> method on
<code>DataArray</code> and <code>Dataset.</code> This method is a
wrapper around <code>Matplotlib</code>’s
<code>matplotlib.pyplot.plot()</code>. <code>xarray</code> will
automatically guess the type of plot based on the dimensionality of the
data. By default <code>.plot()</code> creates:</p>
<ul>
<li><p>a <strong>line</strong> plot for 1-D arrays using
<code>matplotlib.pyplot.plot()</code></p></li>
<li><p>a <strong>pcolormesh</strong> plot for 2-D arrays using
<code>matplotlib.pyplot.pcolormesh()</code></p></li>
<li><p>a <strong>histogram</strong> for everything else (more than 2
dimensions) using <code>matplotlib.pyplot.hist()</code></p></li>
</ul>
<div id="histograms" class="section level3">
<h3>Histograms</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Histogram for all data</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>ds.tas.plot()</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co"># Histogram for a subset of data</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>ds.tas.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2011&quot;</span>)).plot()</span></code></pre></div>
</div>
<div id="d-line-plots" class="section level3">
<h3>1D line plots</h3>
<p>Let’s select one spatial location and plot a time series of the near
surface temperature:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Time series of the near surface temperature at Shenzhen</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>ds.tas.sel(lon<span class="op">=</span><span class="fl">294.1</span>, lat<span class="op">=</span><span class="fl">22.5</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>).plot(marker<span class="op">=</span><span class="st">&quot;o&quot;</span>, size<span class="op">=</span><span class="dv">6</span>)</span></code></pre></div>
<p>Lets say we want to compare plots of temperature at three different
latitudes. We can use the <code>hue</code> keyword argument to do
this.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># Time series of the near surface temperature at 3 latitudes at time stamp 50</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>ds.tas.isel(time<span class="op">=</span><span class="dv">50</span>).sel(lat<span class="op">=</span>[<span class="op">-</span><span class="dv">50</span>, <span class="dv">0</span>, <span class="dv">50</span>], method<span class="op">=</span><span class="st">&quot;nearest&quot;</span>).plot(</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>    x<span class="op">=</span><span class="st">&quot;lon&quot;</span>, hue<span class="op">=</span><span class="st">&quot;lat&quot;</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="d-plots" class="section level3">
<h3>2D plots</h3>
<p>Operator chaining means it is possible to have multiple selection
operators and add <code>.plot()</code> to the end to visualize the
result.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># 2D map over lat (-80,25) and lon (20,160) at timestamp -10</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>ds.tas.isel(time<span class="op">=-</span><span class="dv">10</span>).sel(lon<span class="op">=</span><span class="bu">slice</span>(<span class="dv">20</span>, <span class="dv">160</span>), </span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>                          lat<span class="op">=</span><span class="bu">slice</span>(<span class="op">-</span><span class="dv">80</span>, <span class="dv">25</span>)).plot(robust<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span></code></pre></div>
<p>The x- and y-axes are labeled with full names — “Latitude”,
“Longitude” — along with units. The colorbar has a nice label, again
with units. And the title tells us the timestamp of the data
presented.</p>
<p>You can, of course, modify the color bar:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Define keyword arguments that are passed to matptolib.pyplot.colorbar</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>colorbar_kwargs <span class="op">=</span> {</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>    <span class="st">&quot;orientation&quot;</span>: <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>    <span class="st">&quot;label&quot;</span>: <span class="st">&quot;my clustom label&quot;</span>,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>    <span class="st">&quot;pad&quot;</span>: <span class="fl">0.1</span>,</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>}</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>ds.tas.sel(lon<span class="op">=</span><span class="fl">294.1</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>).plot(</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>    <span class="co"># coordinate to plot on the x-axis of the plot</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    x<span class="op">=</span><span class="st">&quot;time&quot;</span>, </span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>    <span class="co"># set colorbar limits to 2nd and 98th percentile of data</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>,  </span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>colorbar_kwargs,</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="faceting" class="section level3">
<h3>Faceting</h3>
<p>Faceting is an effective way of visualizing variations of 3D data
where 2D slices are visualized in a panel (subplot) and the third
dimensions is varied between panels (subplots).</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Plot monthly mean near surface temperature in 2010 and 2011, one at a panel</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>ds.tas.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2011&quot;</span>)).plot(col<span class="op">=</span><span class="st">&quot;time&quot;</span>, col_wrap<span class="op">=</span><span class="dv">6</span>, robust<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>See the <a
href="https://xarray.pydata.org/en/stable/user-guide/plotting.html"><code>xarray</code>
documentation</a> for more on “faceted” plots or subplots.</p>
</div>
</div>
<div id="computation" class="section level2">
<h2>Computation</h2>
<p>Here we will some basic computation enabled by
<code>xarray.</code></p>
<div id="arithmetic-operations" class="section level3">
<h3>Arithmetic Operations</h3>
<p>Arithmetic operations with a single <code>DataArray</code>
automatically vectorize (like <code>numpy</code>) over all array values.
Let’s convert the air temperature from degree Kelvin to Celsius:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Convert the air temperature from degree Kelvin to Celsius</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>ds.tas <span class="op">-</span> <span class="fl">273.15</span></span></code></pre></div>
<p>Or even square all values in <code>tas</code> (makes no sense, just
for demonstration):</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co"># Convert the air temperature from degree Kelvin to Celsius</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>ds.tas <span class="op">**</span> <span class="dv">2</span></span></code></pre></div>
</div>
<div id="aggregation-methods" class="section level3">
<h3>Aggregation Methods</h3>
<p>A very common step during data analysis is to summarize the data in
question by computing aggregations like <code>sum()</code>,
<code>mean()</code>, <code>median()</code>, <code>min()</code>,
<code>max()</code>, in which reduced data provide insight into the
nature of large dataset. Let’s explore some of these aggregation
methods:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># Compute the mean of all locations and timesteps</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>ds.tas.mean()</span></code></pre></div>
<p>Because we specified no <code>dim</code> argument the function was
applied over all dimensions. It is possible to specify a dimension along
which to compute an aggregation. For example, to calculate the mean in
time for all locations specify the time dimension as the dimension along
which the mean should be calculated:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># Calculate the mean in time for all locations</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>ds.tas.mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>).plot(size<span class="op">=</span><span class="dv">7</span>, robust<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code></pre></div>
<p>Now try:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># Compute temporal min</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>ds.tas.<span class="bu">min</span>(dim<span class="op">=</span>[<span class="st">&#39;time&#39;</span>])</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="co"># Compute spatial sum</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>ds.tas.<span class="bu">sum</span>(dim<span class="op">=</span>[<span class="st">&#39;lat&#39;</span>, <span class="st">&#39;lon&#39;</span>])</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="co"># compute temporal median</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>ds.tas.median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>).plot(size<span class="op">=</span><span class="dv">7</span>, robust<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>For more, check <a
href="https://xarray.pydata.org/en/stable/user-guide/computation.html"><code>xarray</code>
computation</a>.</p>
</div>
<div id="groupby-split-apply-combine" class="section level3">
<h3>GroupBy: split, apply, combine</h3>
<p>Simple aggregations can give useful summary of our dataset, but often
we would prefer to aggregate <strong>conditionally</strong> on some
coordinate labels or groups. <code>Xarray</code> provides the so-called
<code>groupby</code> operation which enables the
<code>split-apply-combine</code> workflow on <code>xarray</code>
<code>DataArrays</code> and <code>Datasets.</code> The
<code>split-apply-combine</code> operation is illustrated in this
figure.</p>
<p><img src="figs/xarray-split-apply-combine.png" alt="drawing" width="700"/></p>
<p><a
href="https://raw.githubusercontent.com/andersy005/xarray-tutorial/6e50dba4ac1c6716755db77e1f1c4bae2625a0d0/images/xarray-split-apply-combine.png">Figure
source</a></p>
<p>This makes clear what the <code>groupby</code> accomplishes:</p>
<ul>
<li><p>The <code>split</code> step involves breaking up and grouping an
<code>xarray</code> <code>Dataset</code> or <code>DataArray</code>
depending on the value of the specified <strong>group
key</strong></p></li>
<li><p>The <code>apply</code> step involves computing some function,
usually an aggregate, transformation, or filtering, within the
individual groups</p></li>
<li><p>The <code>combine</code> step merges the results of these
operations into an output <code>xarray</code> <code>Dataset</code> or
<code>DataArray</code></p></li>
</ul>
<p>We are going to use <code>groupby</code> to remove the seasonal cycle
(“climatology”) from our dataset:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co"># Near surface temperature at Shenzhen</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>ds.tas.sel(lon<span class="op">=</span><span class="fl">294.1</span>, lat<span class="op">=</span><span class="fl">22.5</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>).plot(marker<span class="op">=</span><span class="st">&quot;o&quot;</span>, size<span class="op">=</span><span class="dv">6</span>)</span></code></pre></div>
<p>First, let’s group data by <code>month</code>, i.e. all
<code>Januaries</code> in one group, all <code>Februaries</code> in one
group, etc…</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co"># Group data by month</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>ds.tas.groupby(ds.time.dt.month)</span></code></pre></div>
<p>Here we are using the <code>.dt</code> <a
href="https://xarray.pydata.org/en/stable/generated/xarray.core.accessor_dt.DatetimeAccessor.html"><code>DatetimeAccessor</code></a>
to extract specific components of dates/times in our time coordinate
dimension. You can also try <code>ds.time.dt.year</code> and
<code>ds.time.dt.month</code>, see what happens.</p>
<p><code>Xarray</code> also offers a more concise syntax when the
variable you’re grouping on is already present in the dataset. This is
identical to <code>ds.tas.groupby (ds.time.dt.month)</code>:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># Group data by month</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>ds.tas.groupby(<span class="st">&#39;time.month&#39;</span>)</span></code></pre></div>
<p>Now that we have groups defined, it’s time to “apply” a calculation
to the group. These calculations can either be:</p>
<ul>
<li><p>aggregation: reduces the size of the group</p></li>
<li><p>transformation: preserves the group’s full size</p></li>
</ul>
<p>At then end of the apply step, <code>xarray</code> will automatically
combine the aggregated/transformed groups back into a single object.</p>
<p>Let’s calculate the climatology at every point in the dataset and
plot the results:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co"># Calculate the climatology </span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>tas_clim <span class="op">=</span> ds.tas.groupby(<span class="st">&#39;time.month&#39;</span>).mean()</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>tas_clim</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="co"># Plot climatology at a specific point (Shenzhen)</span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>tas_clim.sel(lon<span class="op">=</span><span class="fl">294.1</span>, lat<span class="op">=</span><span class="fl">22.5</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>).plot()</span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="co"># Plot zonal mean climatology</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>tas_clim.mean(dim<span class="op">=</span><span class="st">&#39;lon&#39;</span>).transpose().plot.contourf(levels<span class="op">=</span><span class="dv">12</span>, robust<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">&#39;turbo&#39;</span>)</span></code></pre></div>
<p>Now let’s combine the previous steps to compute climatology and use
<code>xarray</code>’s groupby arithmetic to remove this climatology from
our original data:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co"># Group data by month</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>group_data <span class="op">=</span> ds.tas.groupby(<span class="st">&#39;time.month&#39;</span>)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="co"># Apply mean to grouped data, and then compute the anomaly </span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>tas_anom <span class="op">=</span> group_data <span class="op">-</span> group_data.mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a>tas_anom</span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a><span class="co"># Plot anomalies at a specific point (Shenzhen)</span></span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a>tas_anom.sel(lon<span class="op">=</span><span class="fl">294.1</span>, lat<span class="op">=</span><span class="fl">22.5</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>).plot()</span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a><span class="co"># Plot global mean anomalies</span></span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a>tas_anom.mean(dim<span class="op">=</span>[<span class="st">&#39;lat&#39;</span>, <span class="st">&#39;lon&#39;</span>]).plot()</span></code></pre></div>
<p>For more, see <a
href="https://xarray.pydata.org/en/stable/user-guide/groupby.html">GroupBy:
split-apply-combine</a>.</p>
</div>
</div>
<div id="masking-data" class="section level2">
<h2>Masking Data</h2>
<p>Using <code>.where()</code> method, elements of an
<code>xarray</code> <code>Dataset</code> or <code>xarray</code>
<code>DataArray</code> that satisfy a given condition or multiple
conditions can be replaced/masked. Unlike <code>.isel()</code> and
<code>sel()</code> that change the shape of the returned results,
<code>.where()</code> preserves the shape of the original data. It does
accomplishes this by returning values from the original
<code>DataArray</code> or <code>Dataset</code> if the condition is
<code>True</code>, and fills in <code>missing values</code> wherever the
condition is <code>False</code>.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># Select data</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>sample <span class="op">=</span> ds.tas.isel(time<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>sample</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a><span class="co"># Sample data where temperature is less than 270</span></span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a>masked_sample <span class="op">=</span> sample.where(sample <span class="op">&lt;</span> <span class="fl">270.0</span>)</span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a>masked_sample</span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a><span class="co"># Plot 2 panels</span></span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">19</span>, <span class="dv">6</span>))</span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a>sample.plot(ax<span class="op">=</span>axes[<span class="dv">0</span>], robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a>masked_sample.plot(ax<span class="op">=</span>axes[<span class="dv">1</span>], robust<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p><code>.where()</code> also allows providing multiple conditions. To
do this, we need to make sure each conditional expression is enclosed in
<code>()</code>. To combine conditions, we use the <code>&amp;</code>
operator and/or <code>|</code>. let’s use where to mask locations with
temperature values less than <code>250</code> and greater than
<code>300</code>:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># More than one condition</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>sample.where((sample <span class="op">&gt;</span> <span class="dv">250</span>) <span class="op">&amp;</span> (sample <span class="op">&lt;</span> <span class="dv">300</span>)).plot(size<span class="op">=</span><span class="dv">6</span>, robust<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co"># More than one condition</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>sample.where((sample.lat <span class="op">&lt;</span> <span class="dv">5</span>) <span class="op">&amp;</span> (sample.lat <span class="op">&gt;</span> <span class="op">-</span><span class="dv">5</span>) <span class="op">&amp;</span> (sample.lon <span class="op">&gt;</span> <span class="dv">190</span>) <span class="op">&amp;</span> </span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>             (sample.lon <span class="op">&lt;</span> <span class="dv">240</span>)).plot(size<span class="op">=</span><span class="dv">6</span>, robust<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>For more, see <a
href="https://xarray.pydata.org/en/stable/user-guide/indexing.html#masking-with-where">Masking
with where</a>.</p>
<hr />
<p><em>The notes are modified from the excellent <a
href="https://rabernat.github.io/research_computing/">Research Computing
in Earth Sciences</a> and <a
href="https://github.com/andersy005/xarray-tutorial/tree/6e50dba4ac1c6716755db77e1f1c4bae2625a0d0">xarray-tutorial</a>
freely available on the GitHub.</em></p>
<hr />
</div>
</div>
<div id="in-class-exercises" class="section level1">
<h1>In-class exercises</h1>
<div id="exercise-1" class="section level2">
<h2>Exercise #1</h2>
<p>Go over the notes, make sure you understand the scripts.</p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise #2</h2>
<p>Compute the global mean temperature between <code>2005-01</code> and
<code>2010-12</code>.</p>
</div>
<div id="exercise-3" class="section level2">
<h2>Exercise #3</h2>
<p>Plot the the seasonal cycle (“climatology”) in temperature near your
hometown.</p>
</div>
<div id="exercise-4" class="section level2">
<h2>Exercise #4</h2>
<p>Plot anomalies at your hometown, do you observe a trend?</p>
</div>
<div id="exercise-5" class="section level2">
<h2>Exercise #5</h2>
<p>Plot monthly climatology in temperature in <code>12</code>
panels.</p>
<hr />
</div>
</div>
<div id="further-reading" class="section level1">
<h1>Further reading</h1>
<ul>
<li><a
href="https://xarray.pydata.org/en/stable/index.html"><code>xarray</code>
offical guide</a></li>
<li><a
href="https://www.unidata.ucar.edu/software/netcdf/docs/index.html">NetCDF
offical guide</a></li>
<li><a
href="https://xarray.pydata.org/en/stable/tutorials-and-videos.html"><code>xarray</code>
Tutorials and Videos</a></li>
<li><a
href="https://gist.github.com/pletchm/f1302a61d81285838d6e4255d460b16f"><code>xarray</code>
Example Cheatsheet</a></li>
<li><a
href="http://pure.iiasa.ac.at/id/eprint/14952/1/xarray-tutorial-egu2017-answers.pdf"><code>Python</code>:
a tutorial introduction to <code>xarray</code></a></li>
<li><a href="https://projectpythia.org/resource-gallery.html">Pythia
Resource Gallery</a> (very comprehensive, contains many courses and
tutorials)</li>
<li><a href="https://www.giss.nasa.gov/tools/panoply/">Panoply</a>
(great tool to visualize and check netCDF files, requires
<code>java runtime environment 9</code>)</li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
